var title;var newMessage=false;var newChat=false;var hasfocus=true;var notifyTimeout=null;var update_request;var update_timeout;var disabled_alert=0;function sound_alert(a){if(a<=disabled_alert){return}try{if(a==1){swfobject.getObjectById("buzzer").newMessageAlert()}else{if(a==2){swfobject.getObjectById("buzzer").newChatAlert()}}}catch(b){}disabled_alert=a;setTimeout("disabled_alert = 0;",2000)}function refresh_unread_text(a){if(a>0){$("#inbox").addClass("attention").html("my chats ("+a+")")}else{$("#inbox").removeClass("attention").html("my chats")}}function alert_new_notifications(b){if(hasfocus){stayTime=5000}else{stayTime=10000}var a=600;if(typeof update_request=="undefined"){a=0}for(m in b){msg=b[m];t='<a style="color: black; text-decoration: none;" href="'+msg.link+'"><div><b>'+msg.username+":</b><br/>"+msg.message+"</div></a>";sound_alert(2);jQuery.noticeAdd({text:t,inEffectDuration:a,stay:false,stayTime:stayTime})}}function refresh_chat_status(a){if(!$("#status").hasClass(a)){if(a=="online"){$("#log").append('<div style="color: #080;">'+peer_username+" is now online</div>")}else{$("#log").append('<div style="color: #666;">'+peer_username+" went offline</div>")}$("#log").animate({scrollTop:$("#log")[0].scrollHeight})}$("#status").removeClass("online offline");$("#status").addClass(a)}function update_title_notification(){if(typeof title=="undefined"){title=$(document).attr("title")}if(newMessage||newChat){if(notifyTimeout==null&&!hasfocus){notifyTimeout=setTimeout("toggle_title()",1000)}}else{if(notifyTimeout!=null){clear_title_notification()}}}function toggle_title(){var a="*"+title;if($(document).attr("title")==a){$(document).attr("title",title)}else{$(document).attr("title",a)}notifyTimeout=setTimeout("toggle_title()",1000)}function clear_title_notification(){newChat=false;newMessage=false;clearTimeout(notifyTimeout);$(document).attr("title",title);notifyTimeout=null}function request_update(d){if(typeof request_timeout!="undefined"){clearTimeout(request_timeout)}if(typeof update_request!="undefined"){update_request.abort()}var e="GET";var a="/getupdate";var c={update_id:update.update_id};var b=2000;if(typeof userchat_key!="undefined"){c.userchat_key=userchat_key;b=2000;a="/getchatupdate"}if(d){c.message=d;e="POST";a="/sendmessage"}if(typeof update.chat_update_id!="undefined"){c.chat_update_id=update.chat_update_id}if(typeof update.chat_timestamp!="undefined"){c.chat_timestamp=update.chat_timestamp}update_request=$.ajax({url:a,type:e,data:c,success:function(f){apply_update(f);update=$.extend(update,f);request_timeout=setTimeout("request_update();",b)},error:function(g,h,f){if(g.status!=0){$("#log").append('<div class="error"><b>Error</b>: Could not connect to server ('+g.status+").</div>");$("#log").animate({scrollTop:$("#log")[0].scrollHeight});request_timeout=setTimeout("request_update();",3000)}}})}function apply_update(b){var c=0;if("unread_count" in b){c=b.unread_count-update.unread_count;if(c!=0){refresh_unread_text(b.unread_count)}}if("notifications" in b&&b.notifications.length){alert_new_notifications(b.notifications);newChat=true;update_title_notification()}else{if(c<0){newChat=false;update_title_notification()}}if("update_id" in b){update.update_id=b.update_id}if("chat_update_id" in b){update.chat_update_id=b.chat_update_id}if("chat_timestamp" in b){update.chat_timestamp=b.chat_timestamp}if("messages_html" in b){var a=b.messages_html;cursor=b.cursor;$("#log").append(a);$("#log").animate({scrollTop:$("#log")[0].scrollHeight});if(!hasfocus){sound_alert(1);newMessage=true;update_title_notification()}}if("status_class" in b){refresh_chat_status(b.status_class)}}$(document).ready(function(){setTimeout("apply_update(update);",1);if(typeof userchat_key=="undefined"){request_timeout=setTimeout("request_update();",2000)}else{$("#message").keypress(function(c){if(c.keyCode=="13"){var d=$("textarea#message").val();if(c.shiftKey){return true}if(d!=""){$("textarea#message").val("");c.preventDefault();request_update(d)}else{return false}}});$("#log").scrollTop($("#log")[0].scrollHeight);request_timeout=setTimeout("request_update();",2000)}var b=function(){hasfocus=true;clear_title_notification()};var a=function(){hasfocus=false};if($.browser.msie){$(document).focusin(b);$(document).focusout(a)}else{$(window).focus(b);$(window).blur(a)}});var random_chat_canceled=false;function random_chat_show_waiting(){$.blockUI.defaults.css={};$.blockUI({message:'<span class="loading">Waiting for a random someone... <a href="#" onclick="random_chat_stop();return false;">Cancel</a></span>',overlayCSS:{opacity:0.2},css:{width:"400px",padding:"10px",left:($(window).width()-420)/2+"px"},applyPlatformOpacityRules:false})}function random_chat_hide_waiting(){$.unblockUI()}function random_chat_stop(){random_chat_canceled=true}function random_chat_retry(){$.ajax({url:"/random",type:"post",success:function(b,c,a){if(a.status==201){window.location.href=b}else{if(random_chat_canceled){random_chat_hide_waiting()}else{setTimeout("random_chat_retry()",2000)}}}})}function random_chat_start(a){random_chat_canceled=false;random_chat_retry();if(a){setTimeout("random_chat_show_waiting()",300)}}function load_more_messages(a){$("#load-more-messages").html("loading...");$.ajax({url:"/load_more_messages",type:"get",data:{userchat_key:userchat_key,cursor:a},success:function(b){$("#load-more-messages").remove();$("#log").prepend(b)},error:function(c,d,b){}})}(function(b){function c(){var d=b(this);setTimeout(function(){var e=d.attr("title");if(!d.val()||(d.val()==e)){d.prev("span").css("visibility","");if(e){var f=b("<label></label>").text(e).css("visibility","hidden").appendTo("body");d.prev("span").css("margin-left",f.width()+3+"px");f.remove()}}else{d.prev("span").css("visibility","hidden")}},0)}function a(){var d=b(this).attr("title");if(!b(this).val()||(b(this).val()==d)){b(this).val(d);b(this).prev("span").css("visibility","")}}b("input, textarea").live("keydown",c);b("input, textarea").live("paste",c);b("select").live("change",c);b("input, textarea").live("focusin",function(){b(this).prev("span").css("color","#bbb")});b("input, textarea").live("focusout",function(){b(this).prev("span").css("color","#999")});b(function(){b("input, textarea").each(function(){c.call(this)})})})(jQuery);